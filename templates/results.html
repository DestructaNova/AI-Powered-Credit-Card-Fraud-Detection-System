{% extends "base.html" %}

{% block title %}Analysis Results - Credit Card Fraud Detection{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-5 fade-in-up">
            <div>
                <h1 class="display-5 gradient-text">
                    <i class="fas fa-chart-pie me-3"></i>
                    Analysis Results
                </h1>
                <p class="lead">AI-powered fraud detection complete</p>
            </div>
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary pulse-animation">
                <i class="fas fa-plus me-2"></i>
                New Analysis
            </a>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-5">
            <div class="col-md-4 mb-3">
                <div class="card cyber-border slide-in-left" style="animation-delay: 0.1s;">
                    <div class="card-body text-center">
                        <i class="fas fa-database fa-3x text-gradient mb-3 glow-effect"></i>
                        <h2 class="gradient-text mb-2">{{ total_transactions }}</h2>
                        <p class="text-cyber">Total Transactions</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card cyber-border slide-in-left" style="animation-delay: 0.2s;">
                    <div class="card-body text-center">
                        <i class="fas fa-exclamation-triangle fa-3x text-gradient mb-3 glow-effect"></i>
                        <h2 class="gradient-text mb-2">{{ fraudulent_count }}</h2>
                        <p class="text-cyber">Fraud Detected</p>
                    </div>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="card cyber-border slide-in-left" style="animation-delay: 0.3s;">
                    <div class="card-body text-center">
                        <i class="fas fa-chart-pie fa-3x text-gradient mb-3 glow-effect"></i>
                        <h2 class="gradient-text mb-2">{{ fraud_percentage }}%</h2>
                        <p class="text-cyber">Fraud Rate</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Summary Alert -->
        {% if fraudulent_count > 0 %}
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">
                <i class="fas fa-shield-alt me-2"></i>
                Fraud Detected!
            </h4>
            <p>
                Our analysis has identified <strong>{{ fraudulent_count }}</strong> potentially fraudulent 
                transactions out of {{ total_transactions }} total transactions 
                ({{ fraud_percentage }}% fraud rate).
            </p>
            <hr>
            <p class="mb-0">
                <i class="fas fa-info-circle me-2"></i>
                Please review the detailed results below and take appropriate action for flagged transactions.
            </p>
        </div>
        {% else %}
        <div class="alert alert-success" role="alert">
            <h4 class="alert-heading">
                <i class="fas fa-check-circle me-2"></i>
                No Fraud Detected
            </h4>
            <p class="mb-0">
                Great news! Our analysis found no fraudulent transactions in your dataset. 
                All {{ total_transactions }} transactions appear to be legitimate.
            </p>
        </div>
        {% endif %}

        <!-- Fraudulent Transactions Table -->
        {% if fraudulent_count > 0 %}
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-table me-2"></i>
                    Fraudulent Transactions Details
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="fraudTable">
                        <thead class="table-dark">
                            <tr>
                                <th>Row Index</th>
                                <th>Time</th>
                                <th>Amount</th>
                                <th>Fraud Probability</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in fraud_transactions %}
                            <tr>
                                <td>
                                    <span class="badge bg-danger">{{ transaction.original_index }}</span>
                                </td>
                                <td>{{ "%.2f"|format(transaction.Time) if transaction.Time is not none else 'N/A' }}</td>
                                <td>
                                    <strong>${{ "%.2f"|format(transaction.Amount) if transaction.Amount is not none else '0.00' }}</strong>
                                </td>
                                <td>
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar bg-danger" 
                                             role="progressbar" 
                                             style="width: {{ (transaction.Fraud_Probability * 100)|round(1) }}%"
                                             aria-valuenow="{{ (transaction.Fraud_Probability * 100)|round(1) }}" 
                                             aria-valuemin="0" 
                                             aria-valuemax="100">
                                            {{ (transaction.Fraud_Probability * 100)|round(1) }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-info" 
                                            onclick="showTransactionDetails({{ loop.index0 }})">
                                        <i class="fas fa-eye me-1"></i>
                                        View Details
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Export Options -->
                <div class="mt-3">
                    <button class="btn btn-success" onclick="exportToCSV()">
                        <i class="fas fa-download me-2"></i>
                        Export Fraudulent Transactions
                    </button>
                    <button class="btn btn-info" onclick="printResults()">
                        <i class="fas fa-print me-2"></i>
                        Print Results
                    </button>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Recommendations -->
        <div class="card mt-4">
            <div class="card-header bg-info text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-lightbulb me-2"></i>
                    Recommendations
                </h5>
            </div>
            <div class="card-body">
                {% if fraudulent_count > 0 %}
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-danger">Immediate Actions:</h6>
                        <ul>
                            <li>Review flagged transactions manually</li>
                            <li>Contact customers for verification</li>
                            <li>Consider blocking suspicious cards temporarily</li>
                            <li>Report to fraud investigation team</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-warning">Preventive Measures:</h6>
                        <ul>
                            <li>Implement real-time monitoring</li>
                            <li>Set up automated alerts</li>
                            <li>Review transaction patterns regularly</li>
                            <li>Update fraud detection rules</li>
                        </ul>
                    </div>
                </div>
                {% else %}
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-success">Monitoring:</h6>
                        <ul>
                            <li>Continue regular fraud monitoring</li>
                            <li>Maintain current security measures</li>
                            <li>Keep fraud detection models updated</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-info">Best Practices:</h6>
                        <ul>
                            <li>Regular data analysis</li>
                            <li>Customer education on security</li>
                            <li>System performance monitoring</li>
                        </ul>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Transaction Details Modal -->
<div class="modal fade" id="transactionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Transaction Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="transactionDetails">
                <!-- Details will be populated by JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Store fraud transactions data for JavaScript access
const fraudTransactions = {{ fraud_transactions | tojson }};

function showTransactionDetails(index) {
    const transaction = fraudTransactions[index];
    const modal = new bootstrap.Modal(document.getElementById('transactionModal'));
    
    let detailsHtml = '<div class="row">';
    
    // Basic info
    detailsHtml += '<div class="col-md-6">';
    detailsHtml += '<h6 class="text-primary">Basic Information</h6>';
    detailsHtml += `<p><strong>Row Index:</strong> ${transaction.original_index}</p>`;
    detailsHtml += `<p><strong>Time:</strong> ${transaction.Time.toFixed(2)}</p>`;
    detailsHtml += `<p><strong>Amount:</strong> $${transaction.Amount.toFixed(2)}</p>`;
    detailsHtml += `<p><strong>Fraud Probability:</strong> ${(transaction.Fraud_Probability * 100).toFixed(2)}%</p>`;
    detailsHtml += '</div>';
    
    // Feature values (V1-V28)
    detailsHtml += '<div class="col-md-6">';
    detailsHtml += '<h6 class="text-primary">Feature Values</h6>';
    detailsHtml += '<div style="max-height: 300px; overflow-y: auto;">';
    
    for (let i = 1; i <= 28; i++) {
        const vKey = `V${i}`;
        if (transaction[vKey] !== undefined) {
            detailsHtml += `<p><strong>${vKey}:</strong> ${transaction[vKey].toFixed(4)}</p>`;
        }
    }
    
    detailsHtml += '</div></div></div>';
    
    document.getElementById('transactionDetails').innerHTML = detailsHtml;
    modal.show();
}

function exportToCSV() {
    let csv = 'Row Index,Time,Amount,Fraud Probability,';
    
    // Add V1-V28 headers
    for (let i = 1; i <= 28; i++) {
        csv += `V${i},`;
    }
    csv = csv.slice(0, -1) + '\n'; // Remove last comma and add newline
    
    // Add data rows
    fraudTransactions.forEach(transaction => {
        csv += `${transaction.original_index},${transaction.Time},${transaction.Amount},${transaction.Fraud_Probability},`;
        
        for (let i = 1; i <= 28; i++) {
            const vKey = `V${i}`;
            csv += `${transaction[vKey] || ''},`;
        }
        csv = csv.slice(0, -1) + '\n'; // Remove last comma and add newline
    });
    
    // Download CSV
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'fraudulent_transactions.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

function printResults() {
    window.print();
}

// Initialize DataTable if available
document.addEventListener('DOMContentLoaded', function() {
    // Add some basic sorting functionality
    const table = document.getElementById('fraudTable');
    if (table) {
        // Add click handlers for sorting (basic implementation)
        const headers = table.querySelectorAll('th');
        headers.forEach((header, index) => {
            if (index < 4) { // Only for sortable columns
                header.style.cursor = 'pointer';
                header.addEventListener('click', () => {
                    console.log(`Sorting by column ${index}`);
                    // Basic sorting implementation could be added here
                });
            }
        });
    }
});
</script>
{% endblock %}
